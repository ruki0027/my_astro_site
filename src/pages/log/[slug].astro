---

import Layout from '../../layouts/Layout.astro'
import { getCollection, getEntryBySlug } from 'astro:content'
import { marked } from 'marked'

// ★ 這段是關鍵：在靜態輸出下，列出要產生的所有 slug
export async function getStaticPaths() {
  const entries = await getCollection('log')
  return entries.map((e) => ({
    params: { slug: e.slug },
  }))
}

const { slug } = Astro.params

const entry = await getEntryBySlug('log', slug!)
if (!entry) {
  throw Astro.redirect('/404')
}

const title = entry.data.title
const date = typeof entry.data.date === 'string' ? new Date(entry.data.date) : entry.data.date ?? new Date()
const html = marked.parse(entry.body)

const fmt = new Intl.DateTimeFormat('zh-TW', {
  year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Taipei'
})
---

<Layout title={title}>
  <main class="post">
    <p class="date">{fmt.format(date)}</p>
    <h1>{title}</h1>
    <div class="content" set:html={html}></div>
    <p class="back"><a href="/log/">← 返回更新日誌</a></p>
  </main>
</Layout>

<style>
.post{max-width:860px;margin:0 auto;padding:2rem 1rem}
.date{opacity:.7;margin:0 0 .25rem}
h1{margin:0 0 1rem}
.content :where(p,ul,ol,pre,blockquote){margin:.75rem 0;line-height:1.8}
.back{margin-top:2rem}
</style>
