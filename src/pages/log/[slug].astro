---

import Layout from '../../layouts/Layout.astro'
import fs from 'node:fs'
import path from 'node:path'
import matter from 'gray-matter'
import { marked } from 'marked'

const { slug } = Astro.params

const logDir = path.resolve('./src/content/log')
const filePath = path.join(logDir, `${slug}.md`)

let title = slug
let date = new Date()
let html = '<p>尚無內容。</p>'

try {
  const raw = fs.readFileSync(filePath, 'utf-8')
  const { data, content } = matter(raw)
  title = data.title ?? slug
  date = data.date ? new Date(data.date) : new Date()
  html = marked.parse(content)
} catch (e) {
  // 找不到檔案就給 404
  throw Astro.redirect('/404')
}

const fmt = new Intl.DateTimeFormat('zh-TW', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  timeZone: 'Asia/Taipei',
})
---

<Layout>
  <main class="post">
    <p class="date">{fmt.format(date)}</p>
    <h1>{title}</h1>
    <div class="content" set:html={html}></div>
    <p class="back"><a href="/log/">← 返回更新日誌</a></p>
  </main>
  
</Layout>

<style>
  .post { max-width: 860px; margin: 0 auto; padding: 2rem 1rem; }
  .date { opacity: .7; margin: 0 0 .25rem; }
  h1 { margin: 0 0 1rem; }
  .content :where(p, ul, ol, pre, blockquote){ margin: .75rem 0; line-height: 1.8; }
  .back { margin-top: 2rem; }
</style>
