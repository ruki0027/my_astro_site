---

import Layout from '../../layouts/Layout.astro'
import { getCollection } from 'astro:content'
import { marked } from 'marked'

const items = (await getCollection('log'))
  .map(e => {
    const d = typeof e.data.date === 'string' ? new Date(e.data.date) : e.data.date
    const html = marked.parse(e.body)
    return {
      slug: e.slug,
      title: e.data.title,
      date: d ?? new Date(),
      html,
      excerpt: html.replace(/<[^>]+>/g, '').slice(0, 120) + (html.length > 120 ? '…' : '')
    }
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime())

const fmt = new Intl.DateTimeFormat('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit', timeZone:'Asia/Taipei' })
---

<Layout>
  <main class="logs">
    <h1>更新日誌</h1>
    {items.map(log => (
      <article class="log">
        <h2><a href={`/log/${log.slug}/`}>{fmt.format(log.date)} — {log.title}</a></h2>
        <p class="excerpt">{log.excerpt}</p>
        <p class="more"><a href={`/log/${log.slug}/`}>閱讀全文 →</a></p>
      </article>
    ))}
  </main>

</Layout>

<style>
.logs{max-width:860px;margin:0 auto;padding:2rem 1rem}
.log{padding:1rem 0;border-bottom:1px solid rgba(0,0,0,.08)}
.log h2{margin:0 0 .5rem;font-size:1.125rem}
.excerpt{margin:.25rem 0 .5rem;line-height:1.6;opacity:.9}
</style>
